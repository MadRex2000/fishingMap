{% extends 'base.html' %}
{% block content %}
{% load i18n %}
<style>
  .filter-group {
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    font-weight: 600;
    position: absolute;
    top: 125px;
    left: 10px;
    z-index: 1;
    border-radius: 3px;
    width: 120px;
    color: #fff;
  }

  .filter-group input[type='checkbox']:first-child + label {
    border-radius: 3px 3px 0 0;
  }

  .filter-group label:last-child {
    border-radius: 0 0 3px 3px;
    border: none;
  }

  .filter-group input[type='checkbox'] {
    display: none;
  }

  .filter-group input[type='checkbox'] + label {
    background-color: #3386c0;
    display: block;
    cursor: pointer;
    padding: 10px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.25);
  }

  .filter-group input[type='checkbox'] + label {
    background-color: #3386c0;
    text-transform: capitalize;
  }

  .filter-group input[type='checkbox'] + label:hover,
  .filter-group input[type='checkbox']:checked + label {
    background-color: #4ea0da;
  }

  .filter-group input[type='checkbox']:checked + label:before {
    content: '✔';
    margin-right: 5px;
  }

  .mapboxgl-popup {
    max-width: 400px;
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  }

  .map-overlay {
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    position: absolute;
    width: 25%;
    top: 0;
    left: 0;
    padding: 10px;
  }

  .map-overlay .map-overlay-inner {
    background-color: #fff;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    border-radius: 3px;
    padding: 10px;
    margin-bottom: 10px;
  }

  .map-overlay h2 {
    line-height: 24px;
    display: block;
    margin: 0 0 10px;
  }

  .map-overlay .legend .bar {
    height: 10px;
    width: 100%;
    background: linear-gradient(to right, #fca107, #7f3121);
  }

  .map-overlay input {
    background-color: transparent;
    display: inline-block;
    width: 100%;
    position: relative;
    margin: 0;
    cursor: ew-resize;
  }
</style>

<div id="map"></div>
<div class="map-overlay top">
  <div class="map-overlay-inner">
    <h2>月份</h2>
    <label id="month"></label>
    <input id="slider" type="range" min="0" max="11" step="1" value="0" />
  </div>
</div>
<nav id="filter-group" class="filter-group"></nav>

<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoicmV4d3UxMTIzIiwiYSI6ImNrYTUyejVkdTBhcGkzaHFmN3RlZXBtZHcifQ.m9Ejwl41uqQfXxNP_H-6rw';
  var places = {
    'type': 'FeatureCollection',
    'features': [{% if areas %}{% for area in areas %}
        {
        'type': 'Feature',
        'geometry': {
          'type': 'Point',
          'coordinates': [{{ area.lon }}, {{ area.lat }}]
        },
        'properties': {
          'location': '{{ area.location }}',
          'district': '{{ area.city }} {{ area.district }}',
          'fish': [{% for branch in area.city.branches_city.all %}{% for fish in branch.fingerling_branch.all %}'{{ fish.name }}',{% endfor %}{% endfor %}]
          }
        },{% endfor %}{% endif %}
    ]
  };

  var fishes = {
    'type': 'FeatureCollection',
    'features': [{% if fingerling %}{% for fish in fingerling %}
      {
        'properties': {
          'name': '{{ fish.name }}',
          'nickname': '{{ fish.nickname }}',
          'branch': '{{ fish.branch }}',
          'month': [{% for month in fish.branch.month.all %}'{{ month }}',{% endfor %}],
          }
      },{% endfor %}{% endif %}
    ]
  }

  var months = [
  '一月',
  '二月',
  '三月',
  '四月',
  '五月',
  '六月',
  '七月',
  '八月',
  '九月',
  '十月',
  '十一月',
  '十二月'
  ];

  var filterGroup = document.getElementById('filter-group');
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [121.741398, 25.131127],
    zoom: 13
  });

  function filterBy(month) {
    var filters = ['==', 'month', month];
    //map.setFilter(layerID, filters);
    document.getElementById('month').textContent = months[month];
  }

  map.on('load', function() {
    {% load static %}
    map.loadImage('{% static "media/icon/food.png" %}', function(error, image) {
       if (error) throw error;
       if (!map.hasImage('border-image')) {
         map.addImage('fishing-area', image);

         map.addSource('areas', {
           'type': 'geojson',
           'data': places
         });

        places.features.forEach(function(feature) {
          var symbol = feature.properties['location'];
          var layerID = symbol;
          if (!map.getLayer(layerID)) {
            map.addLayer({
              'id': layerID,
              'type': 'symbol',
              'source': 'areas',
              'layout': {
                'icon-image': 'fishing-area',
                'icon-size': 0.1,
                'icon-padding': 0,
                'icon-allow-overlap': true
              },
              'filter': ['==', 'location', symbol]
            });
          }
          map.on('click', layerID, function(e) {
            map.getCanvas().style.cursor = 'pointer';
            var feature = e.features[0];
            map.flyTo({ center: feature.geometry.coordinates, zoom: 15 });

            new mapboxgl.Popup({closeButton: false})
            .setLngLat(feature.geometry.coordinates)
            .setText(feature.properties.name)
            .addTo(map);
          });

        var input = document.createElement('input');
        input.type = 'checkbox';
        input.id = layerID;
        input.checked = true;
        filterGroup.appendChild(input);

        var label = document.createElement('label');
        label.setAttribute('for', layerID);
        label.textContent = symbol;
        filterGroup.appendChild(label);
        input.addEventListener('change', function(e){
          map.setLayoutProperty(
            layerID,
            'visibility',
            e.target.checked ? 'visible' : 'none'
          );
        });
      });
    }
  })
  filterBy(0);
  document
  .getElementById('slider')
  .addEventListener('input', function(e) {
    var month = parseInt(e.target.value, 10);
    filterBy(month);
  });
});


map.addControl(new mapboxgl.NavigationControl());
map.addControl(
  new mapboxgl.GeolocateControl({
    positionOptions: {
      enableHighAccuracy: true
    },
    trackUserLocation: true
  })
);



</script>
{% endblock %}
